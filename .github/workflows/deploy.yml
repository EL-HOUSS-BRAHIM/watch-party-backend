name: Deploy to EC2

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH and run remote deploy
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            mkdir -p ${{ secrets.REMOTE_DIR }}
            cd ${{ secrets.REMOTE_DIR }}
            if [ -d .git ]; then
              git fetch --all --prune
              git reset --hard origin/${{ github.ref_name }}
              git clean -fd
            else
              git clone --depth 1 -b ${GITHUB_REF_NAME:-master} https://github.com/${{ github.repository }} .
            fi
            # Run deploy script as root
            export AUTO_CONFIRM=1
            export RUN_ACTION=${{ secrets.RUN_ACTION || '1' }}
            sudo bash deploy.sh
